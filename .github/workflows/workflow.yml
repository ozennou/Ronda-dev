name: CI Workflow

on:
    push:
        branches: [ "main" ]
        paths-ignore: ["**/*.md"]

    pull_request:
        branches: [ "main" ]
        paths-ignore: ["**/*.md"]
    workflow_dispatch:

jobs:
    # build:
    #     runs-on: ubuntu-24.04
    #     steps:
    #         - uses: actions/checkout@v4
    
    #         - name: Create .env file
    #           run: |
    #               cat << EOF > .env
    #               POSTGRES_USER=${{ secrets.POSTGRES_USER }}
    #               POSTGRES_PASSWD=${{ secrets.POSTGRES_PASSWORD }}
    #               REDIS_PASSWD=${{ secrets.REDIS_PASSWD }}
    #               POSTGRES_HOST=${{ vars.POSTGRES_HOST }}
    #               POSTGRES_DB=${{ vars.POSTGRES_DB }}
    #               EOF
        
    #         - name: Build and Run
    #           run: |
    #             docker compose up -d
    #             docker ps

    #         - name: Health check
    #           run: |
    #             sleep 30
    #             docker ps
    #             docker logs app
    #             echo ------
    #             docker logs database
    #             curl --fail http://localhost:8000/healthz 1>&2 2>/dev/null
            
              
    # test:
    #     runs-on: ubuntu-24.04
    #     needs: build
    #     strategy:
    #         # max-parallel: 3
    #         matrix:
    #           python-version: [3.9]
    #     steps:
    #         - uses: actions/checkout@v4
    
    #         - name: Set up python ${{ matrix.python-version }}
    #           uses: actions/setup-python@v3
    #           with:
    #             python-version: ${{ matrix.python-version }}

    #         - name: Install dependencies
    #           run: |
    #             cd src
    #             python -m pip install --upgrade pip
    #             pip install -r Requirements.txt

    #         - name: Run tests
    #           run: python src/manage.py test

    # push_image:
    #     runs-on: ubuntu-24.04
    #     needs: test
    #     if: github.event_name == 'push'
    #     steps:
    #         - uses: actions/checkout@v4

    #         - name: Login to DockerHub
    #           uses: docker/login-action@v3
    #           with:
    #             username: ${{ vars.DOCKERHUB_USERNAME }}
    #             password: ${{ secrets.DOCKERHUB_TOKEN }}

    #         - name: Build
    #           run: docker compose build

    #         - name: push docker image
    #           run: |
    #             docker tag ozennou/ronda_game:latest ozennou/ronda_game:0.0.${GITHUB_RUN_NUMBER}v
    #             docker push ozennou/ronda_game:0.0.${GITHUB_RUN_NUMBER}v
    #             docker push ozennou/ronda_game:latest

    deployment:
        runs-on: ubuntu-24.04
        # needs: push_image
        steps:
            - name: Workflow Dispatch and wait
              # You may pin to the exact commit or the version.
              # uses: the-actions-org/workflow-dispatch@93e95b157d791ae7f42aef8f8a0d3d723eba1c31
              uses: the-actions-org/workflow-dispatch@v2.1.1
              with:
                # Name or ID of workflow to run
                workflow: CD.yml
                # GitHub token with repo write access, can NOT use secrets.GITHUB_TOKEN, see readme
                token: ${{ secret.G_TOKEN}}
                # Inputs to pass to the workflow, must be a JSON string. All values must be strings (even if used as boolean or number)
                ref: ozennou/Ronda-deploy/
                # Repo owner & name, slash separated, only set if invoking a workflow in a different repo
                repo: main
                # Get the URL of the triggered workflow and display it in logs (useful to follow the progress of the triggered workflow)
                display-workflow-run-url: true
                # The time to wait (+unit) between two polls to get the URL of the workflow run
                wait-for-completion: true
                # Maximum amount of time (+unit) to wait to mark workflow as timed out
                wait-for-completion-timeout: 1m
                      

    deployment2:
        runs-on: ubuntu-24.04
        # needs: push_image
        steps:
            - name: Workflow Dispatch
              # You may pin to the exact commit or the version.
              # uses: benc-uk/workflow-dispatch@25b02cc069be46d637e8fe2f1e8484008e9e9609
              uses: benc-uk/workflow-dispatch@v1.2.3
              with:
                # Name, filename or ID of workflow to run
                workflow: CD.yml
                # GitHub token with repo write access, only required if the workflow is in a different repository
                token:  ${{ github.token }}
                # Inputs to pass to the workflow, must be a JSON string
                # inputs: # optional
                # The reference can be a branch, tag, or a commit SHA
                ref: main
                # Repo owner & name, slash separated, only set if invoking a workflow in a different repo
                repo: ozennou/Ronda-deploy
          











        
